/* https://github.com/blacklabel/grouped_categories/blob/master/grouped-categories.js */

(function(e){function d(e,t){this.name=e.name||e;this.parent=t;return this}function v(e){return e!==t&&e!==null}function m(e){return parseInt(e,10)-.5}function g(e){var t=e.length,n=0;while(t--)n+=e[t];return n}function y(e,t,n,r,s){var o=e.length,u;s||(s=0);n.depth||(n.depth=0);while(o--){u=e[o];if(r)u.parent=r;if(u.categories)y(u.categories,t,n,u,s+1);else b(t,u,r)}n.depth=i(n.depth,s)}function b(e,t,n){e.unshift(new d(t,n));while(n){n.leaves++||(n.leaves=1);n=n.parent}}function w(e,t){e.push("M",m(t[0]),m(t[1]),"L",m(t[2]),m(t[3]))}function E(e){var t;while(e){t=e.parent;if(e.label)e.label.destroy();delete e.parent;delete e.label;e=t}}function S(e,t){return e.getPosition(e.axis.horiz,t,e.axis.tickmarkOffset)}function x(e,t,n){var r=e.length,i;while(r--){i=e[r][t];if(i)x(i,t,n);n(e[r])}}function T(e){function r(e){return Object.prototype.toString.call(e)==="[object Array]"}function i(e){return Object.prototype.toString.call(e)==="[object String]"}var t,n;t=r(e)?[]:{};for(n in e){if(e.hasOwnProperty(n)){if(i(e[n])){t[n]=e[n]}else{t[n]=T(e[n])}}}return t}var t=void 0,n=Math.round,r=Math.min,i=Math.max,s=e.Axis.prototype,o=e.Tick.prototype,u=s.init,a=s.render,f=s.setCategories,l=o.getLabelSize,c=o.addLabel,h=o.destroy,p=o.render;d.prototype.toString=function(){var e=[],t=this;while(t){e.push(t.name);t=t.parent}return e.join(", ")};s.init=function(e,t){u.call(this,e,t);if(typeof t==="object"&&t.categories)this.setupGroups(t)};s.setupGroups=function(e){var t,n=[],r={};t=T(e.categories);y(t,n,r);this.categoriesTree=t;this.categories=n;this.isGrouped=r.depth!==0;this.labelsDepth=r.depth;this.labelsSizes=[];this.labelsGridPath=[];this.tickLength=e.tickLength||this.tickLength||null;this.directionFactor=[-1,1,1,-1][this.side];this.options.lineWidth=e.lineWidth||1};s.render=function(){if(this.isGrouped)this.labelsGridPath=[];if(this.originalTickLength===t)this.originalTickLength=this.options.tickLength;this.options.tickLength=this.isGrouped?.001:this.originalTickLength;a.call(this);if(!this.isGrouped){if(this.labelsGrid)this.labelsGrid.attr({visibility:"hidden"});return}var e=this,n=e.options,r=e.top,i=e.left,s=i+e.width,o=r+e.height,u=e.hasVisibleSeries,f=e.labelsDepth,l=e.labelsGrid,c=e.horiz,h=e.labelsGridPath,p=n.drawHorizontalBorders===false?f+1:0,d=e.opposite?c?r:s:c?o:i,v;if(e.userTickLength)f-=1;if(!l){l=e.labelsGrid=e.chart.renderer.path().attr({strokeWidth:n.lineWidth,stroke:n.lineColor}).add(e.axisGroup)}while(p<=f){d+=e.groupSize(p);v=c?[i,d,s,d]:[d,r,d,o];w(h,v);p++}l.attr({d:h,visibility:u?"visible":"hidden"});e.labelGroup.attr({visibility:u?"visible":"hidden"});x(e.categoriesTree,"categories",function(t){var n=t.tick;if(!n)return;if(n.startAt+n.leaves-1<e.min||n.startAt>e.max){n.label.hide();n.destroyed=0}else n.label.show()})};s.setCategories=function(e,t){if(this.categories)this.cleanGroups();this.setupGroups({categories:e});this.categories=this.userOptions.categories=e;f.call(this,this.categories,t)};s.cleanGroups=function(){var e=this.ticks,t;for(t in e)if(e[t].parent);delete e[t].parent;x(this.categoriesTree,"categories",function(e){var t=e.tick,n;if(!t)return;t.label.destroy();for(n in t)delete t[n];delete e.tick});this.labelsGrid=null};s.groupSize=function(e,n){var r=this.labelsSizes,s=this.directionFactor;if(n!==t)r[e]=i(r[e]||0,n+10);if(e===true)return g(r)*s;else if(r[e])return r[e]*s;return 0};o.addLabel=function(){var e;c.call(this);if(!this.axis.categories||!(e=this.axis.categories[this.pos]))return;if(e.name)this.label.attr("text",e.name);if(this.axis.isGrouped)this.addGroupedLabels(e)};o.addGroupedLabels=function(e){var t=this,n=this.axis,r=n.chart,i=n.options.labels,s=i.useHTML,o=i.style,u={align:n.horiz?"center":"right"},a=n.horiz?"height":"width",f=0,l;while(t){if(f>0&&!e.tick){l=r.renderer.text(e.name,0,0,s).attr(u).css(o).add(n.labelGroup);t.startAt=this.pos;t.childCount=e.categories.length;t.leaves=e.leaves;t.visible=this.childCount;t.label=l;e.tick=t}n.groupSize(f,t.label.getBBox()[a]);e=e.parent;if(e)t=t.parent=e.tick||{};else t=null;f++}};o.render=function(e,t,n){p.call(this,e,false,n);if(!this.axis.isGrouped||!this.axis.categories[this.pos]||this.pos>this.axis.max)return;var s=this,o=s,u=s.axis,a=s.pos,f=s.isFirst,l=u.max,c=u.min,h=u.horiz,d=u.categories[a],v=u.labelsGridPath,m=u.groupSize(0),g=u.tickLength||m,y=u.directionFactor,b=S(s,a),E=h?b.y:b.x,x=1,T,N,C,k;if(f){T=h?[u.left,b.y,u.left,b.y+u.groupSize(true)]:u.isXAxis?[b.x,u.top,b.x+u.groupSize(true),u.top]:[b.x,u.top+u.len,b.x+u.groupSize(true),u.top+u.len];w(v,T)}T=h?[b.x,b.y,b.x,b.y+m]:[b.x,b.y,b.x+m,b.y];w(v,T);m=E+m;while(o=o.parent){minPos=S(s,i(o.startAt-1,c-1));maxPos=S(s,r(o.startAt+o.leaves-1,l));k=o.label.getBBox();N=u.groupSize(x);C=h?{x:(minPos.x+maxPos.x)/2,y:k.height*y+m+4}:{x:m,y:(minPos.y+maxPos.y+k.height)/2};o.label.attr(C);if(v){T=h?[maxPos.x,m,maxPos.x,m+N]:[m,maxPos.y,m+N,maxPos.y];w(v,T)}m+=N;x++}};o.destroy=function(){var e=this;while(e=e.parent)e.destroyed++||(e.destroyed=1);h.call(this)};o.getLabelSize=function(){if(this.axis.isGrouped===true)return g(this.axis.labelsSizes);else return l.call(this)}})(Highcharts)